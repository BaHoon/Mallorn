# 智能重试机制说明

## 修改概述

已成功实现智能重试机制，确保通知重试时只重新发送失败的渠道，避免重复发送已成功的渠道。

## 核心改进

### 1. 智能渠道检测 (`SendNotificationChannelsAsync`)

**新增逻辑**：
- 在重试前检查每个渠道的当前状态
- 只发送失败或未发送的渠道
- 跳过已成功的渠道

**检测机制**：
```csharp
// SignalR渠道检测
var existingSignalR = await _context.SignalRNotifications
    .FirstOrDefaultAsync(sr => sr.NotificationId == notification.NotificationId);
bool needSendSignalR = forceResend || existingSignalR == null || 
                      existingSignalR.SendStatus != SignalRNotification.SendStatuses.Success;

// Email渠道检测  
var existingEmail = await _context.EmailNotifications
    .FirstOrDefaultAsync(en => en.NotificationId == notification.NotificationId);
bool needSendEmail = forceResend || existingEmail == null || 
                    existingEmail.SendStatus != EmailNotification.SendStatuses.Success;
```

### 2. 多层重试架构

#### 主通知层重试 (每分钟)
- **方法**: `NotifiSenderService.RetryFailedNotificationsAsync()`  
- **触发**: NotificationBackgroundService 每分钟执行
- **作用**: 重试整体失败的通知，但内部使用智能渠道检测

#### 渠道层重试 (每2分钟)  
- **方法**: `NotifiSenderService.RetryAllChannelFailuresAsync()`
- **触发**: NotificationBackgroundService 每2分钟执行
- **作用**: 专门重试各渠道的失败记录
- **范围**: 
  - SignalR失败重试: `SignalRNotificationService.RetryFailedSignalRNotificationsAsync()`
  - Email失败重试: `EmailService.RetryFailedEmailNotificationsAsync()`

### 3. 执行时间表

```
每10秒: 处理新通知队列
每1分钟（0-10秒）: 主通知层重试
每2分钟（30-40秒）: 渠道层重试  
每5分钟（0-10秒）: 状态统计输出
```

## 工作流程示例

### 场景1: SignalR成功，Email失败
1. **初次发送**: SignalR ✅, Email ❌
2. **主通知状态**: Pending (因为Email失败)
3. **重试时**: 
   - 检测到SignalR已成功 → 跳过SignalR发送
   - 检测到Email失败 → 重新发送Email
   - 避免SignalR重复发送

### 场景2: 两个渠道都失败
1. **初次发送**: SignalR ❌, Email ❌  
2. **主通知状态**: Pending
3. **重试时**:
   - 检测到SignalR失败 → 重新发送SignalR
   - 检测到Email失败 → 重新发送Email
   - 两个渠道都重试

### 场景3: 渠道独立重试
1. **情况**: 某些SignalR/Email记录由于网络等原因单独失败
2. **渠道层重试**: 
   - 每2分钟独立重试SignalR失败记录
   - 每2分钟独立重试Email失败记录
   - 不依赖主通知状态

## 技术优势

✅ **避免重复发送**: 已成功的渠道不会重复发送  
✅ **精确重试**: 只重试真正失败的部分  
✅ **多层保障**: 主通知重试 + 渠道独立重试  
✅ **时间分散**: 不同类型重试错开执行，减少系统压力  
✅ **日志完整**: 详细记录跳过和重试的原因  

## 配置参数

- **主通知重试间隔**: 1分钟
- **渠道重试间隔**: 2分钟  
- **最大重试次数**: 由各实体类的 `MaxRetryCount` 定义
- **重试等待时间**: 由各实体类的 `DefaultRetryIntervalMinutes` 定义

## 日志输出示例

```
[INFO] 跳过SignalR通知（已成功） - NotificationId: 123
[INFO] 发送邮件通知 - NotificationId: 123  
[INFO] 重试渠道失败通知: SignalR(0总/0成功), Email(3总/2成功)
```

这样的重试机制确保了高效、准确且无重复的通知发送。
