# 邮件验证码定期清理功能

## 功能概述

`EmailVerificationCleanupTask` 是一个定期清理过期邮件验证码记录的后台任务，防止数据库中验证码数据无限增长。

## 功能特性

### 🔄 自动清理策略
- **执行频率**: 每天执行一次
- **清理过期记录**: 删除24小时前过期或已使用的验证码
- **保留审计数据**: 保留最近24小时内的数据用于审计

### 📊 智能监控
- **大量清理告警**: 当单次清理超过100条记录时记录详细信息
- **积压监控**: 当系统中过期记录超过1000条时发出警告
- **任务状态跟踪**: 提供详细的任务执行状态信息

### 🛡️ 错误处理
- **异常捕获**: 自动捕获和记录清理过程中的异常
- **失败重试**: 在下次调度时自动重试失败的清理操作
- **日志记录**: 详细记录清理过程和结果

## 配置信息

### 任务参数
```csharp
// 执行间隔
protected override TimeSpan Interval => TimeSpan.FromDays(1);

// 过期数据保留期
var expiredBefore = DateTime.Now.AddHours(-24);

// 用户记录保留数量
int keepLatestCount = 10; // 每个用户保留最新10条记录
```

### 清理阈值
- **正常清理**: 0-100条记录/次
- **大量清理**: >100条记录/次（触发信息日志）
- **积压警告**: >1000条过期记录（触发警告日志）

## 监控和日志

### 执行日志示例
```
[INFO] 开始执行邮件验证码清理任务
[INFO] 邮件验证码清理任务执行完成 - 清理过期记录: 45条, 当前剩余过期记录: 12条, 用户记录清理: 0条
[INFO] 大量邮件验证码记录被清理，建议检查系统邮件发送频率是否正常 - 清理数量: 150
[WARN] 系统中仍有大量过期邮件验证码记录 (1200条)，建议检查清理策略或增加清理频率
```

### 任务状态查询
通过 `ScheduledTaskController` 可以查询任务状态：
```json
{
  "TaskName": "EmailVerificationCleanupTask",
  "Description": "邮件验证码清理任务 - 每天清理过期和已使用的验证码记录",
  "CleanupStrategy": {
    "ExpiredRecordsRetention": "24小时",
    "UserRecordsRetention": "最新10条",
    "ExecutionFrequency": "每天一次"
  },
  "Status": {
    "IsExecuting": false,
    "LastExecutionTime": "2025-08-10T02:00:00Z",
    "NextExecutionTime": "2025-08-11T02:00:00Z",
    "ExecutionCount": 15,
    "Status": "正常"
  }
}
```

## 数据库影响

### 清理对象
清理任务主要处理 `EmailVerification` 表中的记录：
- **过期记录**: `ExpireTime < expiredBefore`
- **已使用记录**: `IsUsed = 1`
- **旧记录**: 每个用户保留最新N条记录

### 性能优化
- **批量删除**: 使用 `RemoveRange` 批量删除记录
- **索引利用**: 基于 `ExpireTime`, `IsUsed`, `UserId`, `CreatedAt` 字段查询
- **事务保护**: 在 UnitOfWork 事务中执行清理操作

## 部署配置

### 服务注册
任务已在 `Program.cs` 中自动注册：
```csharp
builder.Services.AddHostedService<EmailVerificationCleanupTask>();
```

### 依赖项
- `IUnitOfWork`: 数据访问工作单元
- `IEmailVerificationRepository`: 邮件验证仓储
- `ILogger<EmailVerificationCleanupTask>`: 日志记录器

## 最佳实践

### 🔍 监控建议
1. **定期检查日志**: 关注清理数量和执行状态
2. **设置告警**: 当大量清理或积压时及时响应
3. **性能监控**: 观察清理对数据库性能的影响

### ⚡ 优化建议
1. **清理频率**: 根据系统邮件发送量调整清理频率
2. **保留策略**: 根据审计需求调整数据保留时间
3. **批量大小**: 根据数据库性能调整批量处理大小

### 🛠️ 故障排除
1. **清理失败**: 检查数据库连接和权限
2. **性能问题**: 检查数据库索引和查询执行计划
3. **数据积压**: 考虑增加清理频率或优化清理策略

## 相关API

### 查询任务状态
```http
GET /api/scheduledtask/status
```

### 获取邮件验证码统计
```http
GET /api/notification/email-stats
```

## 版本历史

- **v1.0.0** (2025-08-10): 初始版本，支持基础清理功能
  - 每日定期清理过期记录
  - 智能监控和告警
  - 完整的错误处理和日志记录
