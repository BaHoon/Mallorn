# 通知系统重构架构文档

## 概述

本次重构将原有的单一通知发送器拆分为三个独立的服务，实现了更好的职责分离和可维护性：

1. **SignalRNotificationService** - 专门处理SignalR实时通知
2. **EmailService** - 统一处理所有邮件发送（合并了原EmailNotificationService）
3. **NotifiSenderService** - 协调器，负责调用上述两个服务并管理整体发送逻辑

## 架构设计

### 服务层级关系

```
NotifiSenderService (协调器)
    ├── SignalRNotificationService (SignalR发送)
    └── EmailService (邮件发送)
```

### 数据库实体关系

```
Notification (主通知实体)
    ├── SignalRNotification[] (SignalR发送记录)
    └── EmailNotification[] (邮件发送记录)
```

## 服务详细说明

### 1. NotifiSenderService (主协调器)

**职责：**
- 协调SignalR和邮件通知的发送
- 管理主通知状态
- 实现发送成功规则：SignalR必须成功 + 用户有邮箱时邮件也必须成功
- 提供批量处理和重试功能

**关键方法：**
- `SendNotificationAsync()` - 发送单个通知
- `ProcessNotificationQueueAsync()` - 批量处理通知队列
- `RetryFailedNotificationsAsync()` - 重试失败的主通知
- `RetryAllChannelFailuresAsync()` - 协调重试所有渠道
- `GetDetailedStatsAsync()` - 获取所有渠道的详细统计

### 2. SignalRNotificationService

**职责：**
- 专门处理SignalR实时通知发送
- 管理SignalR发送记录和状态
- 提供SignalR特定的重试机制

**特性：**
- 支持单播（ConnectionId）和群播（GroupName）
- 最大重试3次，间隔1分钟
- 详细的错误日志和状态跟踪

**关键方法：**
- `SendSignalRNotificationAsync()` - 发送SignalR通知
- `RetryFailedSignalRNotificationsAsync()` - 重试失败的SignalR通知
- `GetSignalRStatsAsync()` - 获取SignalR统计信息

### 3. EmailService (合并后的邮件服务)

**职责：**
- 处理所有类型的邮件发送
- 管理邮件发送记录和状态
- 支持通知邮件和验证码邮件两种类型

**特性：**
- 最大重试5次，间隔5分钟
- 支持HTML邮件格式
- 验证码邮件过期时间管理
- 邮件模板包装

**关键方法：**
- `SendEmailAsync()` - 简单邮件发送（不记录数据库）
- `SendNotificationEmailAsync()` - 通知类型邮件（记录数据库）
- `SendVerificationCodeEmailAsync()` - 验证码邮件
- `ValidateVerificationCodeAsync()` - 验证码校验
- `RetryFailedEmailNotificationsAsync()` - 重试失败的邮件

## 发送成功规则

### 通知发送成功判定：

1. **用户有邮箱**：SignalR成功 AND 邮件成功 = 整体成功
2. **用户无邮箱**：SignalR成功 = 整体成功

### 重试机制：

- **主通知重试**：由NotifiSenderService管理，最多5次
- **SignalR重试**：由SignalRNotificationService管理，最多3次
- **邮件重试**：由EmailService管理，最多5次

## 使用示例

### 发送单个通知
```csharp
var result = await notifiSenderService.SendNotificationAsync(notificationId);
if (result.Success)
{
    Console.WriteLine($"通知发送成功: {result.ErrorMessage}");
}
```

### 批量处理通知队列
```csharp
var (total, success, failed) = await notifiSenderService.ProcessNotificationQueueAsync(10);
Console.WriteLine($"处理完成 - 总计: {total}, 成功: {success}, 失败: {failed}");
```

### 发送验证码邮件
```csharp
var result = await emailService.SendVerificationCodeEmailAsync(
    "user@example.com", 
    "123456", 
    "注册验证", 
    10);
```

### 获取详细统计
```csharp
var stats = await notifiSenderService.GetDetailedStatsAsync();
Console.WriteLine(JsonSerializer.Serialize(stats, new JsonSerializerOptions { WriteIndented = true }));
```

## 配置依赖注入

在 `Program.cs` 或 `Startup.cs` 中注册服务：

```csharp
// 注册通知相关服务
services.AddScoped<SignalRNotificationService>();
services.AddScoped<EmailService>();
services.AddScoped<NotifiSenderService>();

// 注册SignalR Hub
services.AddSignalR();
```
